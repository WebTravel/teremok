'use strict';

;(function ($, window, document) {

  //defaults value
  var defaults = {
    'width': 1024,
    'next': '<span class="arrow">&rsaquo;</span>',
    'prev': '<span class="back-arrow">&lsaquo;</span>',
    'linkSwitch': false,
    'showParent': true
  };

  function MultiMenu(element, options) {
    //vars block
    this.options = $.extend({}, defaults, options);
    this.element = element;
    this.init();
  }

  //call init function
  MultiMenu.prototype.init = function () {

    var self = this,
        element = this.element,
        elementAttrId = element.attr('id'),
        elementAttrClass = element.attr('class'),
        arrClassList = [],
        attrIdList = [],
        arrClassItem = [],
        arrClassLink = [],
        childrenList = element.find('ul'),
        childrenItem = element.find('li'),
        childrenLink = element.find('a'),
        menuEnabled = false;

    //Parse Attr menuElements
    function addAttrInArr(el, attribute, arr) {
      el.each(function (indx) {
        if ($(this).attr(attribute) != undefined) {
          arr.push($(this).attr(attribute));
        } else {
          arr.push('');
        }
      });
    }

    //OutParse Attr menuElements
    function outAttrArr(el, attr, arr) {
      el.each(function (indx) {
        var attrValue = arr[indx];
        $(this).attr(attr, attrValue);
      });
    }

    //create animate-menu function
    function openMenu() {
      $('body').toggleClass('bodyFixed');
      setTimeout(function () {
        $('.multilevelMenu ul').attr('class', '');
      }, 200);
    }

    //swipe function for open menu
    function SwipeOpenMenu() {
      //create swipe-selector
      if ($('.multilevelMenu').length > 0) {
        $('body').append('<span class="js-swipe"></span>');
        var touchstartX = 0,
            touchendX = 0;
        // open menu on tap swipe
        $('.js-swipe, .multilevelMenu').on('touchstart', function (e) {
          touchstartX = e.originalEvent.changedTouches[0].pageX;
        });

        $('.js-swipe').on('touchend', function (e) {
          touchendX = e.originalEvent.changedTouches[0].pageX;
          if (touchendX > touchstartX) {
            //call animate-menu function
            openMenu();
            element.find('ul').attr('style', '');
          }
        });

        //close menu left-swipe
        $('.multilevelMenu').on('touchend', function (e) {
          touchendX = e.originalEvent.changedTouches[0].pageX;
          if (touchendX < touchstartX - 30) {
            $('body').removeClass('bodyFixed');
            setTimeout(function () {
              $('.multilevelMenu ul').attr('class', '');
            }, 200);
          }
        });
      } else {
        return false;
      }
    }

    addAttrInArr(childrenList, 'class', arrClassList);
    addAttrInArr(childrenList, 'id', attrIdList);
    addAttrInArr(childrenItem, 'class', arrClassItem);
    addAttrInArr(childrenLink, 'class', arrClassLink);

    //add Overlay
    //$('body').append('<div class="multilevelOverlay js-overlay"></div>');

    //create work-menu function
    function mobileMenu() {
      var w = window.innerWidth ? window.innerWidth : $(window).width();

      //next level function
      function nextLevelFunction(e, el) {
        e.preventDefault();
        e.stopPropagation();
        var elem = el.closest('li').children('ul'),
            elemHeight = elem.innerHeight() + 15;
        el.parents('ul').addClass('close-list').height(elemHeight);
        elem.addClass('active-menu').height(elemHeight);
      }

      //add text for prev button function
      function textPrevButton(str, el) {
        if (str.length > 0) {
          str = str.substring(0, str.length - 1);
        }
        el.closest('li').find('li.back').text(str).append(self.options.prev);
      }

      if (w < self.options.width) {
        //remove attr
        if (!menuEnabled) {
          menuEnabled = true;
          element.removeAttr('id');
          element.removeClass();
          element.addClass('multilevelMenu');
          childrenList.removeClass();
          childrenList.removeAttr('id');
          childrenItem.removeClass();
          childrenLink.removeClass();

          //call swipe function
          SwipeOpenMenu();
          //add switch-button for children ul
          var link = element.find('a');
          link.append(function (indx, val) {
            var out = '';
            if ($(this).parent('li').find('ul').length > 0) {
              out = self.options.next;
            }
            return $(out).addClass('js-arrow');
          });
          //add back-button function
          element.find('li').find('ul').prepend('<li class="back js-back">Назад</li>');

          //view next level menu full button
          if (self.options.linkSwitch == true) {
            $(link).on("click", function (e) {
              if ($(this).next('ul').length > 0) {
                nextLevelFunction(e, $(this));
              }
              //name prev-button text
              var str = $(this).text();
              textPrevButton(str, $(this));
            });
          } else {
            //view next level menu on only arrow
            $(link).on("click", ".js-arrow", function (e) {
              nextLevelFunction(e, $(this));
              //name prev-button text
              var str = $(this).parents('a').text();
              textPrevButton(str, $(this));
            });
          }

          //view prev level menu to click "back"
          $('.js-back').click(function () {
            var parent = $(this).closest('ul.close-list'),
                parentHeight = 0;
            parent.children('li').each(function (idx) {
              parentHeight += $(this).innerHeight();
            });
            parent.removeClass('close-list');
            $(this).parents('ul').innerHeight(parentHeight);
            $(this).closest('ul').addClass('hidden-menu').attr('style', '');
            var that = this;
            setTimeout(function () {
              $(that).closest('ul').removeClass('active-menu hidden-menu');
            }, 200);
          });
        }
      } else {
        if (menuEnabled) {
          //return attr
          menuEnabled = false;
          element.attr('id', elementAttrId);
          element.attr('class', elementAttrClass);
          element.find('ul').attr('style', '');
          outAttrArr(childrenList, 'class', arrClassList);
          outAttrArr(childrenList, 'id', attrIdList);
          outAttrArr(childrenItem, 'class', arrClassItem);
          outAttrArr(childrenLink, 'class', arrClassLink);
          $('.js-arrow, .js-back, .js-swipe').detach();
        }

        $('body').removeClass('bodyFixed'); //remove fixedClass to body
      }
    }

    //call work-menu function
    mobileMenu();

    //remove attr resize
    $(window).resize(function () {
      //call work-menu function
      mobileMenu();
    });

    //animate menu function Call
    $('.js-toggle').add($('.js-overlay')).on("click", function () {
      //call animate-menu function
      openMenu();
      element.find('ul').attr('style', '');
    });
  };

  $.fn.mobileMenu = function (options) {
    new MultiMenu(this.first(), options);
    return this.first();
  };
})(jQuery, window, document);
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vYmlsZU1lbnUuanMiXSwibmFtZXMiOlsiJCIsIndpbmRvdyIsImRvY3VtZW50IiwiZGVmYXVsdHMiLCJNdWx0aU1lbnUiLCJlbGVtZW50Iiwib3B0aW9ucyIsImV4dGVuZCIsImluaXQiLCJwcm90b3R5cGUiLCJzZWxmIiwiZWxlbWVudEF0dHJJZCIsImF0dHIiLCJlbGVtZW50QXR0ckNsYXNzIiwiYXJyQ2xhc3NMaXN0IiwiYXR0cklkTGlzdCIsImFyckNsYXNzSXRlbSIsImFyckNsYXNzTGluayIsImNoaWxkcmVuTGlzdCIsImZpbmQiLCJjaGlsZHJlbkl0ZW0iLCJjaGlsZHJlbkxpbmsiLCJtZW51RW5hYmxlZCIsImFkZEF0dHJJbkFyciIsImVsIiwiYXR0cmlidXRlIiwiYXJyIiwiZWFjaCIsImluZHgiLCJ1bmRlZmluZWQiLCJwdXNoIiwib3V0QXR0ckFyciIsImF0dHJWYWx1ZSIsIm9wZW5NZW51IiwidG9nZ2xlQ2xhc3MiLCJzZXRUaW1lb3V0IiwiU3dpcGVPcGVuTWVudSIsImxlbmd0aCIsImFwcGVuZCIsInRvdWNoc3RhcnRYIiwidG91Y2hlbmRYIiwib24iLCJlIiwib3JpZ2luYWxFdmVudCIsImNoYW5nZWRUb3VjaGVzIiwicGFnZVgiLCJyZW1vdmVDbGFzcyIsIm1vYmlsZU1lbnUiLCJ3IiwiaW5uZXJXaWR0aCIsIndpZHRoIiwibmV4dExldmVsRnVuY3Rpb24iLCJwcmV2ZW50RGVmYXVsdCIsInN0b3BQcm9wYWdhdGlvbiIsImVsZW0iLCJjbG9zZXN0IiwiY2hpbGRyZW4iLCJlbGVtSGVpZ2h0IiwiaW5uZXJIZWlnaHQiLCJwYXJlbnRzIiwiYWRkQ2xhc3MiLCJoZWlnaHQiLCJ0ZXh0UHJldkJ1dHRvbiIsInN0ciIsInN1YnN0cmluZyIsInRleHQiLCJwcmV2IiwicmVtb3ZlQXR0ciIsImxpbmsiLCJ2YWwiLCJvdXQiLCJwYXJlbnQiLCJuZXh0IiwicHJlcGVuZCIsImxpbmtTd2l0Y2giLCJjbGljayIsInBhcmVudEhlaWdodCIsImlk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ZmlsZSI6Im1vYmlsZU1lbnUuanMiLCJzb3VyY2VzQ29udGVudCI6WyI7IChmdW5jdGlvbiAoJCwgd2luZG93LCBkb2N1bWVudCkge1xuXG4gIC8vZGVmYXVsdHMgdmFsdWVcbiAgdmFyIGRlZmF1bHRzID0ge1xuICAgICd3aWR0aCcgOiAxMDI0LFxuICAgICduZXh0JyA6ICc8c3BhbiBjbGFzcz1cImFycm93XCI+JnJzYXF1bzs8L3NwYW4+JyxcbiAgICAncHJldicgOiAnPHNwYW4gY2xhc3M9XCJiYWNrLWFycm93XCI+JmxzYXF1bzs8L3NwYW4+JyxcbiAgICAnbGlua1N3aXRjaCcgOiBmYWxzZSxcbiAgICAnc2hvd1BhcmVudCc6IHRydWVcbiAgfTtcblxuICBmdW5jdGlvbiBNdWx0aU1lbnUgKGVsZW1lbnQsIG9wdGlvbnMpIHtcbiAgICAvL3ZhcnMgYmxvY2tcbiAgICB0aGlzLm9wdGlvbnMgPSAkLmV4dGVuZCh7fSwgZGVmYXVsdHMsIG9wdGlvbnMpO1xuICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7XG4gICAgdGhpcy5pbml0KCk7XG4gIH1cblxuICAvL2NhbGwgaW5pdCBmdW5jdGlvblxuICBNdWx0aU1lbnUucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbiAoKSB7XG5cbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzLFxuICAgICAgICAgIGVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsXG4gICAgICAgICAgZWxlbWVudEF0dHJJZCA9IGVsZW1lbnQuYXR0cignaWQnKSxcbiAgICAgICAgICBlbGVtZW50QXR0ckNsYXNzID0gZWxlbWVudC5hdHRyKCdjbGFzcycpLFxuICAgICAgICAgIGFyckNsYXNzTGlzdCA9IFtdLFxuICAgICAgICAgIGF0dHJJZExpc3QgPSBbXSxcbiAgICAgICAgICBhcnJDbGFzc0l0ZW0gPSBbXSxcbiAgICAgICAgICBhcnJDbGFzc0xpbmsgPSBbXSxcbiAgICAgICAgICBjaGlsZHJlbkxpc3QgPSBlbGVtZW50LmZpbmQoJ3VsJyksXG4gICAgICAgICAgY2hpbGRyZW5JdGVtID0gZWxlbWVudC5maW5kKCdsaScpLFxuICAgICAgICAgIGNoaWxkcmVuTGluayA9IGVsZW1lbnQuZmluZCgnYScpLFxuICAgICAgICAgIG1lbnVFbmFibGVkID0gZmFsc2U7XG5cbiAgICAgICAgLy9QYXJzZSBBdHRyIG1lbnVFbGVtZW50c1xuICAgICAgICBmdW5jdGlvbiBhZGRBdHRySW5BcnIoZWwsIGF0dHJpYnV0ZSwgYXJyKSB7XG4gICAgICAgICAgZWwuZWFjaChmdW5jdGlvbihpbmR4KSB7XG4gICAgICAgICAgICBpZigkKHRoaXMpLmF0dHIoYXR0cmlidXRlKSAhPSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgYXJyLnB1c2goJCh0aGlzKS5hdHRyKGF0dHJpYnV0ZSkpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgYXJyLnB1c2goJycpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9PdXRQYXJzZSBBdHRyIG1lbnVFbGVtZW50c1xuICAgICAgICBmdW5jdGlvbiBvdXRBdHRyQXJyKGVsLCBhdHRyLCBhcnIpIHtcbiAgICAgICAgICBlbC5lYWNoKGZ1bmN0aW9uKGluZHgpIHtcbiAgICAgICAgICAgIHZhciBhdHRyVmFsdWUgPSBhcnJbaW5keF07XG4gICAgICAgICAgICAkKHRoaXMpLmF0dHIoYXR0ciwgYXR0clZhbHVlKVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9jcmVhdGUgYW5pbWF0ZS1tZW51IGZ1bmN0aW9uXG4gICAgICAgIGZ1bmN0aW9uIG9wZW5NZW51KCkge1xuICAgICAgICAgICQoJ2JvZHknKS50b2dnbGVDbGFzcygnYm9keUZpeGVkJyk7XG4gICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICQoJy5tdWx0aWxldmVsTWVudSB1bCcpLmF0dHIoJ2NsYXNzJywgJycpO1xuICAgICAgICAgIH0sIDIwMCk7XG4gICAgICAgIH1cblxuICAgICAgICAvL3N3aXBlIGZ1bmN0aW9uIGZvciBvcGVuIG1lbnVcbiAgICAgICAgZnVuY3Rpb24gU3dpcGVPcGVuTWVudSgpIHtcbiAgICAgICAgICAvL2NyZWF0ZSBzd2lwZS1zZWxlY3RvclxuICAgICAgICAgIGlmICgkKCcubXVsdGlsZXZlbE1lbnUnKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAkKCdib2R5JykuYXBwZW5kKCc8c3BhbiBjbGFzcz1cImpzLXN3aXBlXCI+PC9zcGFuPicpO1xuICAgICAgICAgICAgdmFyIHRvdWNoc3RhcnRYID0gMCxcbiAgICAgICAgICAgICAgICB0b3VjaGVuZFggPSAwO1xuICAgICAgICAgICAgLy8gb3BlbiBtZW51IG9uIHRhcCBzd2lwZVxuICAgICAgICAgICAgJCgnLmpzLXN3aXBlLCAubXVsdGlsZXZlbE1lbnUnKS5vbigndG91Y2hzdGFydCcsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgdG91Y2hzdGFydFggPSBlLm9yaWdpbmFsRXZlbnQuY2hhbmdlZFRvdWNoZXNbMF0ucGFnZVg7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgJCgnLmpzLXN3aXBlJykub24oJ3RvdWNoZW5kJywgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgdG91Y2hlbmRYID0gZS5vcmlnaW5hbEV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYO1xuICAgICAgICAgICAgICBpZiAodG91Y2hlbmRYID4gdG91Y2hzdGFydFgpIHtcbiAgICAgICAgICAgICAgICAvL2NhbGwgYW5pbWF0ZS1tZW51IGZ1bmN0aW9uXG4gICAgICAgICAgICAgICAgb3Blbk1lbnUoKTtcbiAgICAgICAgICAgICAgICBlbGVtZW50LmZpbmQoJ3VsJykuYXR0cignc3R5bGUnLCAnJyk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvL2Nsb3NlIG1lbnUgbGVmdC1zd2lwZVxuICAgICAgICAgICAgJCgnLm11bHRpbGV2ZWxNZW51Jykub24oJ3RvdWNoZW5kJywgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgdG91Y2hlbmRYID0gZS5vcmlnaW5hbEV2ZW50LmNoYW5nZWRUb3VjaGVzWzBdLnBhZ2VYO1xuICAgICAgICAgICAgICBpZiAodG91Y2hlbmRYIDwgKHRvdWNoc3RhcnRYIC0gMzApKSB7XG4gICAgICAgICAgICAgICAgJCgnYm9keScpLnJlbW92ZUNsYXNzKCdib2R5Rml4ZWQnKTtcbiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICQoJy5tdWx0aWxldmVsTWVudSB1bCcpLmF0dHIoJ2NsYXNzJywgJycpO1xuICAgICAgICAgICAgICAgIH0sIDIwMCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgYWRkQXR0ckluQXJyKGNoaWxkcmVuTGlzdCwgJ2NsYXNzJywgYXJyQ2xhc3NMaXN0KTtcbiAgICAgICAgYWRkQXR0ckluQXJyKGNoaWxkcmVuTGlzdCwgJ2lkJywgYXR0cklkTGlzdCk7XG4gICAgICAgIGFkZEF0dHJJbkFycihjaGlsZHJlbkl0ZW0sICdjbGFzcycsIGFyckNsYXNzSXRlbSk7XG4gICAgICAgIGFkZEF0dHJJbkFycihjaGlsZHJlbkxpbmssICdjbGFzcycsIGFyckNsYXNzTGluayk7XG5cbiAgICAgICAgLy9hZGQgT3ZlcmxheVxuICAgICAgICAvLyQoJ2JvZHknKS5hcHBlbmQoJzxkaXYgY2xhc3M9XCJtdWx0aWxldmVsT3ZlcmxheSBqcy1vdmVybGF5XCI+PC9kaXY+Jyk7XG5cbiAgICAgICAgLy9jcmVhdGUgd29yay1tZW51IGZ1bmN0aW9uXG4gICAgICAgIGZ1bmN0aW9uIG1vYmlsZU1lbnUoKSB7XG4gICAgICAgICAgdmFyIHcgPSB3aW5kb3cuaW5uZXJXaWR0aCA/IHdpbmRvdy5pbm5lcldpZHRoIDogJCh3aW5kb3cpLndpZHRoKCk7XG5cbiAgICAgICAgICAvL25leHQgbGV2ZWwgZnVuY3Rpb25cbiAgICAgICAgICBmdW5jdGlvbiBuZXh0TGV2ZWxGdW5jdGlvbiAoZSwgZWwpIHtcbiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgICAgICB2YXIgZWxlbSA9IGVsLmNsb3Nlc3QoJ2xpJykuY2hpbGRyZW4oJ3VsJyksXG4gICAgICAgICAgICAgICAgZWxlbUhlaWdodCA9IGVsZW0uaW5uZXJIZWlnaHQoKSArIDE1O1xuICAgICAgICAgICAgZWwucGFyZW50cygndWwnKS5hZGRDbGFzcygnY2xvc2UtbGlzdCcpLmhlaWdodChlbGVtSGVpZ2h0KTtcbiAgICAgICAgICAgIGVsZW0uYWRkQ2xhc3MoJ2FjdGl2ZS1tZW51JykuaGVpZ2h0KGVsZW1IZWlnaHQpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vYWRkIHRleHQgZm9yIHByZXYgYnV0dG9uIGZ1bmN0aW9uXG4gICAgICAgICAgZnVuY3Rpb24gdGV4dFByZXZCdXR0b24gKHN0ciwgZWwpIHtcbiAgICAgICAgICAgIGlmIChzdHIubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICBzdHIgPSBzdHIuc3Vic3RyaW5nKDAsIHN0ci5sZW5ndGggLSAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsLmNsb3Nlc3QoJ2xpJykuZmluZCgnbGkuYmFjaycpLnRleHQoc3RyKS5hcHBlbmQoc2VsZi5vcHRpb25zLnByZXYpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmICh3IDwgc2VsZi5vcHRpb25zLndpZHRoKSB7XG4gICAgICAgICAgICAvL3JlbW92ZSBhdHRyXG4gICAgICAgICAgICAgaWYgKCFtZW51RW5hYmxlZCkge1xuICAgICAgICAgICAgICAgICAgbWVudUVuYWJsZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVBdHRyKCdpZCcpO1xuICAgICAgICAgICAgICAgICAgZWxlbWVudC5yZW1vdmVDbGFzcygpO1xuICAgICAgICAgICAgICAgICAgZWxlbWVudC5hZGRDbGFzcygnbXVsdGlsZXZlbE1lbnUnKTtcbiAgICAgICAgICAgICAgICAgIGNoaWxkcmVuTGlzdC5yZW1vdmVDbGFzcygpO1xuICAgICAgICAgICAgICAgICAgY2hpbGRyZW5MaXN0LnJlbW92ZUF0dHIoJ2lkJyk7XG4gICAgICAgICAgICAgICAgICBjaGlsZHJlbkl0ZW0ucmVtb3ZlQ2xhc3MoKTtcbiAgICAgICAgICAgICAgICAgIGNoaWxkcmVuTGluay5yZW1vdmVDbGFzcygpO1xuXG4gICAgICAgICAgICAgICAgICAvL2NhbGwgc3dpcGUgZnVuY3Rpb25cbiAgICAgICAgICAgICAgICAgIFN3aXBlT3Blbk1lbnUoKTtcbiAgICAgICAgICAgICAgICAgIC8vYWRkIHN3aXRjaC1idXR0b24gZm9yIGNoaWxkcmVuIHVsXG4gICAgICAgICAgICAgICAgICB2YXIgbGluayA9IGVsZW1lbnQuZmluZCgnYScpO1xuICAgICAgICAgICAgICAgICAgbGluay5hcHBlbmQoZnVuY3Rpb24oaW5keCwgdmFsKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBvdXQgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgaWYoJCh0aGlzKS5wYXJlbnQoJ2xpJykuZmluZCgndWwnKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgb3V0ID0gc2VsZi5vcHRpb25zLm5leHQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICQob3V0KS5hZGRDbGFzcygnanMtYXJyb3cnKTtcbiAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgLy9hZGQgYmFjay1idXR0b24gZnVuY3Rpb25cbiAgICAgICAgICAgICAgICAgIGVsZW1lbnQuZmluZCgnbGknKS5maW5kKCd1bCcpLnByZXBlbmQoJzxsaSBjbGFzcz1cImJhY2sganMtYmFja1wiPtCd0LDQt9Cw0LQ8L2xpPicpO1xuXG4gICAgICAgICAgICAgICAgICAvL3ZpZXcgbmV4dCBsZXZlbCBtZW51IGZ1bGwgYnV0dG9uXG4gICAgICAgICAgICAgICAgICBpZiAoc2VsZi5vcHRpb25zLmxpbmtTd2l0Y2ggPT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICAkKGxpbmspLm9uKFwiY2xpY2tcIiwgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICBpZiAoJCh0aGlzKS5uZXh0KCd1bCcpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG5leHRMZXZlbEZ1bmN0aW9uIChlLCAkKHRoaXMpKTtcbiAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgLy9uYW1lIHByZXYtYnV0dG9uIHRleHRcbiAgICAgICAgICAgICAgICAgICAgICB2YXIgc3RyID0gJCh0aGlzKS50ZXh0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgdGV4dFByZXZCdXR0b24gKHN0ciwgJCh0aGlzKSk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAvL3ZpZXcgbmV4dCBsZXZlbCBtZW51IG9uIG9ubHkgYXJyb3dcbiAgICAgICAgICAgICAgICAgICAgJChsaW5rKS5vbihcImNsaWNrXCIsIFwiLmpzLWFycm93XCIsIGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgbmV4dExldmVsRnVuY3Rpb24gKGUsICQodGhpcykpO1xuICAgICAgICAgICAgICAgICAgICAgIC8vbmFtZSBwcmV2LWJ1dHRvbiB0ZXh0XG4gICAgICAgICAgICAgICAgICAgICAgdmFyIHN0ciA9ICQodGhpcykucGFyZW50cygnYScpLnRleHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICB0ZXh0UHJldkJ1dHRvbiAoc3RyLCAkKHRoaXMpKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgIC8vdmlldyBwcmV2IGxldmVsIG1lbnUgdG8gY2xpY2sgXCJiYWNrXCJcbiAgICAgICAgICAgICAgICAgICQoJy5qcy1iYWNrJykuY2xpY2soZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcGFyZW50ID0gJCh0aGlzKS5jbG9zZXN0KCd1bC5jbG9zZS1saXN0JyksXG4gICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRIZWlnaHQgPSAwO1xuICAgICAgICAgICAgICAgICAgICBwYXJlbnQuY2hpbGRyZW4oJ2xpJykuZWFjaChmdW5jdGlvbihpZHgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudEhlaWdodCArPSAkKHRoaXMpLmlubmVySGVpZ2h0KCk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBwYXJlbnQucmVtb3ZlQ2xhc3MoJ2Nsb3NlLWxpc3QnKTtcbiAgICAgICAgICAgICAgICAgICAgJCh0aGlzKS5wYXJlbnRzKCd1bCcpLmlubmVySGVpZ2h0KHBhcmVudEhlaWdodCk7XG4gICAgICAgICAgICAgICAgICAgICQodGhpcykuY2xvc2VzdCgndWwnKS5hZGRDbGFzcygnaGlkZGVuLW1lbnUnKS5hdHRyKCdzdHlsZScsICcnKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgICAkKHRoYXQpLmNsb3Nlc3QoJ3VsJykucmVtb3ZlQ2xhc3MoJ2FjdGl2ZS1tZW51IGhpZGRlbi1tZW51Jyk7XG4gICAgICAgICAgICAgICAgICAgIH0sIDIwMCk7XG4gICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlICB7XG4gICAgICAgICAgICAgaWYgKG1lbnVFbmFibGVkKSB7XG4gICAgICAgICAgICAgICAgLy9yZXR1cm4gYXR0clxuICAgICAgICAgICAgICAgIG1lbnVFbmFibGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgZWxlbWVudC5hdHRyKCdpZCcsIGVsZW1lbnRBdHRySWQpO1xuICAgICAgICAgICAgICAgIGVsZW1lbnQuYXR0cignY2xhc3MnLCBlbGVtZW50QXR0ckNsYXNzKTtcbiAgICAgICAgICAgICAgICBlbGVtZW50LmZpbmQoJ3VsJykuYXR0cignc3R5bGUnLCAnJyk7XG4gICAgICAgICAgICAgICAgb3V0QXR0ckFycihjaGlsZHJlbkxpc3QsICdjbGFzcycsIGFyckNsYXNzTGlzdCk7ICBcbiAgICAgICAgICAgICAgICBvdXRBdHRyQXJyKGNoaWxkcmVuTGlzdCwgJ2lkJywgYXR0cklkTGlzdCk7ICAgXG4gICAgICAgICAgICAgICAgb3V0QXR0ckFycihjaGlsZHJlbkl0ZW0sICdjbGFzcycsIGFyckNsYXNzSXRlbSk7XG4gICAgICAgICAgICAgICAgb3V0QXR0ckFycihjaGlsZHJlbkxpbmssICdjbGFzcycsIGFyckNsYXNzTGluayk7ICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAkKCcuanMtYXJyb3csIC5qcy1iYWNrLCAuanMtc3dpcGUnKS5kZXRhY2goKTtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICQoJ2JvZHknKS5yZW1vdmVDbGFzcygnYm9keUZpeGVkJyk7IC8vcmVtb3ZlIGZpeGVkQ2xhc3MgdG8gYm9keVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy9jYWxsIHdvcmstbWVudSBmdW5jdGlvblxuICAgICAgICBtb2JpbGVNZW51KCk7XG5cbiAgICAgICAgLy9yZW1vdmUgYXR0ciByZXNpemVcbiAgICAgICAgJCh3aW5kb3cpLnJlc2l6ZShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgLy9jYWxsIHdvcmstbWVudSBmdW5jdGlvblxuICAgICAgICAgIG1vYmlsZU1lbnUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy9hbmltYXRlIG1lbnUgZnVuY3Rpb24gQ2FsbFxuICAgICAgICAkKCcuanMtdG9nZ2xlJykuYWRkKCQoJy5qcy1vdmVybGF5JykpLm9uKFwiY2xpY2tcIiwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgLy9jYWxsIGFuaW1hdGUtbWVudSBmdW5jdGlvblxuICAgICAgICAgICAgb3Blbk1lbnUoKTtcbiAgICAgICAgICAgIGVsZW1lbnQuZmluZCgndWwnKS5hdHRyKCdzdHlsZScsICcnKTtcbiAgICAgICAgfSk7XG4gIH07XG5cbiAgJC5mbi5tb2JpbGVNZW51ID0gZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICBuZXcgTXVsdGlNZW51KHRoaXMuZmlyc3QoKSwgb3B0aW9ucyk7XG4gICAgcmV0dXJuIHRoaXMuZmlyc3QoKTtcbiAgfTtcblxufSkoalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50KTsiXX0=
